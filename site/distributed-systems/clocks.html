
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clocks | Elijah's Notes</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Explains the concepts of physical and virtual clocks in distributed systems, including their limitations and potential solutions.">
    <meta name="author" content="Elijah Melton">
    <meta name="robots" content="index, follow">
    <meta name="generator" content="Custom Static Site Generator">
    <link rel="canonical" href="https://notes.elimelt.com/distributed-systems/clocks.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="Clocks">
    <meta property="og:description" content="Explains the concepts of physical and virtual clocks in distributed systems, including their limitations and potential solutions.">
    <meta property="og:url" content="https://notes.elimelt.com/distributed-systems/clocks.html">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Clocks">
    <meta name="twitter:description" content="Explains the concepts of physical and virtual clocks in distributed systems, including their limitations and potential solutions.">

    <meta name="keywords" content="clocks,distributed systems,logical clocks,vector clocks,causality,consistency">

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json">
    {"@context": "https://schema.org", "@type": "Article", "headline": "Clocks", "dateModified": "2025-02-11T16:42:07.874013", "description": "Explains the concepts of physical and virtual clocks in distributed systems, including their limitations and potential solutions.", "articleSection": "Distributed Systems", "keywords": "clocks,distributed systems,logical clocks,vector clocks,causality,consistency"}
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js"></script>

    <!-- Configure KaTeX auto-render -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "\[", right: "\]", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\(", right: "\)", display: false}
                ],
                preProcess: (math) => {
                    console.log("Pre-processing: " + math);
                    math = math.split("\n").map((line) => {
                        if (line.endsWith("\\")) {
                            return line + "\\";
                        }
                        return line;
                    }).join("\n");
                    return math;
                },
                throwOnError: false
            });
        });
    </script>

<style>
    :root {
    --text-color: #1a1a1a;
    --background-color: #ffffff;
    --accent-color: #2563eb;
    --accent-light: rgba(37, 99, 235, 0.1);
    --border-color: #e5e7eb;
    --nav-background: rgba(255, 255, 255, 0.95);
    --code-background: #f3f4f6;
    --transition-speed: 0.2s;
    --content-width: 50rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 2rem;
    --spacing-xl: 3rem;
    --radius-sm: 4px;
    --radius-md: 8px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
}

@media (prefers-color-scheme: dark) {
    :root {
        --text-color: #f3f4f6;
        --background-color: #1a1a1a;
        --accent-color: #60a5fa;
        --accent-light: rgba(96, 165, 250, 0.1);
        --border-color: #374151;
        --nav-background: rgba(26, 26, 26, 0.95);
        --code-background: #2d3748;
    }
}

/* Reset and base styles */
*, *::before, *::after {
    box-sizing: border-box;
}

html {
    font-size: 100%;
    scroll-behavior: smooth;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
    max-width: var(--content-width);
    margin: 0 auto;
    padding: var(--spacing-md);
    color: var(--text-color);
    background: var(--background-color);
    transition: background-color var(--transition-speed), color var(--transition-speed);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

@media (min-width: 768px) {
    body {
        padding: var(--spacing-lg);
    }
}

/* Improved navigation */
nav {
    position: sticky;
    top: 0;
    background: var(--nav-background);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    padding: var(--spacing-md) 0;
    margin: calc(-1 * var(--spacing-md));
    margin-bottom: var(--spacing-lg);
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    z-index: 1000;
    width: calc(100% + var(--spacing-md) * 2);
    padding-left: var(--spacing-md);
    padding-right: var(--spacing-md);
    box-shadow: var(--shadow-sm);
}

@media (min-width: 768px) {
    nav {
        margin: calc(-1 * var(--spacing-lg));
        width: calc(100% + var(--spacing-lg) * 2);
        padding-left: var(--spacing-lg);
        padding-right: var(--spacing-lg);
        gap: var(--spacing-md);
    }
}

nav a {
    color: var(--accent-color);
    text-decoration: none;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    transition: background-color var(--transition-speed), color var(--transition-speed);
    font-weight: 500;
}

nav a:hover, nav a:focus {
    background-color: var(--accent-light);
    outline: none;
}

nav a:focus-visible {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
}

/* Improved breadcrumbs */
.breadcrumbs {
    margin-bottom: var(--spacing-lg);
    color: var(--text-color);
    opacity: 0.8;
    font-size: 0.9rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.breadcrumbs a {
    color: var(--accent-color);
    text-decoration: none;
    transition: color var(--transition-speed);
}

.breadcrumbs a:hover {
    text-decoration: underline;
}

.breadcrumbs span:not(:last-child)::after {
    content: "/";
    margin-left: 0.5rem;
    opacity: 0.5;
}

/* Article styles */
article {
    margin-bottom: var(--spacing-xl);
}

h1, h2, h3, h4, h5, h6 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    line-height: 1.3;
    font-weight: 600;
}

h1 {
    font-size: 2rem;
    margin-top: 0;
}

h2 {
    font-size: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

/* Meta information styling */
.meta {
    color: var(--text-color);
    opacity: 0.8;
    font-size: 0.9rem;
    margin-bottom: var(--spacing-lg);
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
}

/* Improved code blocks */
code {
    background: var(--code-background);
    padding: 0.2rem 0.4rem;
    border-radius: var(--radius-sm);
    font-size: 0.9em;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
}

pre {
    background: var(--code-background);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin: var(--spacing-lg) 0;
    box-shadow: var(--shadow-sm);
}

pre code {
    background: none;
    padding: 0;
    border-radius: 0;
}

/* Improved links */
a {
    color: var(--accent-color);
    text-decoration: none;
    transition: color var(--transition-speed);
}

a:hover {
    text-decoration: underline;
}

/* Improved image handling */
img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    margin: var(--spacing-lg) 0;
    display: block;
    box-shadow: var(--shadow-md);
}

/* Table improvements */
table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--spacing-lg) 0;
    overflow-x: auto;
    display: block;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-sm);
}

@media (min-width: 768px) {
    table {
        display: table;
    }
}

th, td {
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    text-align: left;
}

th {
    background: var(--border-color);
    font-weight: 600;
}

/* Tags styling */
.tags {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
}

.tags a {
    display: inline-block;
    background: var(--border-color);
    color: var(--text-color);
    padding: 0.2rem 0.6rem;
    border-radius: var(--radius-sm);
    text-decoration: none;
    font-size: 0.9em;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    transition: background-color var(--transition-speed), color var(--transition-speed);
}

.tags a:hover {
    background: var(--accent-color);
    color: white;
    text-decoration: none;
}

/* Footer improvements */
footer {
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
    text-align: center;
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Blockquote styling */
blockquote {
    margin: var(--spacing-lg) 0;
    padding-left: var(--spacing-md);
    border-left: 4px solid var(--accent-color);
    color: var(--text-color);
    opacity: 0.9;
    font-style: italic;
}

/* Improved KaTeX rendering */
.katex-display {
    overflow: auto hidden;
    padding: var(--spacing-md) 0;
    margin: var(--spacing-md) 0;
    background: var(--accent-light);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
}

.katex-display > .katex {
    white-space: normal;
}

.katex {
    font-size: 1.1em;
    line-height: 1.2;
}

.katex-display .katex {
    display: block;
    text-align: center;
}

.katex-display > .katex > .katex-html {
    display: block;
    max-width: 100%;
    overflow-x: auto;
    padding: 0.5em 0;
    min-height: 40px;
}

/* Index page styling */
.landing-stats {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    justify-content: space-around;
}

.stat-item {
    text-align: center;
    padding: var(--spacing-md);
    background: var(--accent-light);
    border-radius: var(--radius-md);
    flex: 1;
    min-width: 100px;
    box-shadow: var(--shadow-sm);
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent-color);
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
}

.landing-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
}

@media (min-width: 768px) {
    .landing-grid {
        grid-template-columns: 3fr 1fr;
    }

    .recent-section {
        grid-column: 1 / 2;
    }

    .categories-section, .tags-section {
        grid-column: 2 / 3;
    }
}

.recent-posts, .categories-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.recent-posts li, .categories-list li {
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--border-color);
}

.recent-posts li:last-child, .categories-list li:last-child {
    border-bottom: none;
}

.recent-posts .date, .recent-posts .category, .categories-list .count {
    font-size: 0.85rem;
    opacity: 0.7;
    margin-left: var(--spacing-sm);
}

.tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
}

.tags-cloud a {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--border-color);
    border-radius: var(--radius-sm);
    text-decoration: none;
    transition: background-color var(--transition-speed), color var(--transition-speed);
}

.tags-cloud a:hover {
    background: var(--accent-color);
    color: white;
    text-decoration: none;
}

.tag-size-1 { font-size: 0.8rem; }
.tag-size-2 { font-size: 0.9rem; }
.tag-size-3 { font-size: 1rem; }
.tag-size-4 { font-size: 1.1rem; }
.tag-size-5 { font-size: 1.2rem; }

/* Focus styles for accessibility */
*:focus-visible {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
}

/* Print styles */
@media print {
    nav, .breadcrumbs, .tags, footer {
        display: none;
    }

    body {
        max-width: none;
        padding: 0;
        color: black;
        background: white;
    }

    a {
        color: black;
        text-decoration: underline;
    }

    .content {
        max-width: 100%;
    }
}
</style></head>
<body>
    <header>
        <nav role="navigation" aria-label="Main navigation">
            <a href="/index.html">Home</a>
<a href="/categories/index.html">Categories</a>
<a href="/tags/index.html">Tags</a>
        </nav>
        <div class="breadcrumbs" role="navigation" aria-label="Breadcrumb">
            <a href="/index.html">Home</a> » <a href="/categories/distributed%20systems.html">Distributed Systems</a> » Clocks
        </div>
    </header>
    <main role="main">
        <article>
            <h1>Clocks</h1>
            <div class="meta">
                <time datetime="2025-02-11T16:42:07.874013">
                    Last modified: 2025-02-11
                </time>
                <span>Category: <a href="/categories/distributed%20systems.html">Distributed Systems</a></span>
            </div>
            <div class="content">
                <h1 id="clocks">Clocks</h1>
<p>There are two main approaches to time in a distributed system: <strong>physical clocks</strong> and <strong>virtual (logical) clocks</strong>.</p>
<h2 id="physical-clocks">Physical Clocks</h2>
<p>Actual clocks running in most computers drift apart by ~30 ppm due to their temperature sensitivity. Although more accurate clocks (atomic, GPS, etc.) are available, they are expensive and are only <em>maybe</em> present in some data centers.</p>
<p>The crux of the problem is that physical clocks are not perfectly synchronized, and the sending of messages between processes can introduce unpredictable delays. In general, network latency is unpredictable, but with a lower bound.</p>
<p>A practical, albeit naive approach might be to use NTP and have clients query a set of time servers. Then, take the minimum (or some average, subtracting outliers) of the readings received. This can synchronize to ~50 microseconds in a LAN.</p>
<p>Such a system was implemented with <strong>Google Huygens</strong>. Some interesting optimizations they added include:</p>
<ul>
<li>Time-stamping packets in the NIC to avoid OS scheduling overhead</li>
<li>Only included evenly-spaced packets in their sampling as a heuristic for no queuing delay</li>
<li>Estimate relative clock phase and drift between pairs</li>
<li>Sample pairs and use linear algebra to correct peer-to-peer clock skew</li>
</ul>
<p>This enabled them to achieve a 50 ns clock skew 99% of the time. This is okay if time is only used as a hint, but shows that even with all of the above optimizations, it isn't good enough.</p>
<p>To drive this point home, due to the massive scale Google operates at (1 billion RPCs/sec = 10 million clock skews above 50ns per sec), even for a minimum sized message that takes 2 ns to send in a high-performance network, thousands of instructions can be executed on a single server's processor.</p>
<h2 id="virtual-clocks">Virtual Clocks</h2>
<p>We want to design systems such that the ordering of events that can be concurrently executed <strong>doesn't</strong> matter, and the ordering of events that must be performed sequentially is enforced on all possible executions.</p>
<p>Virtual clocks are a framework for reasoning about the order of events using <strong>no</strong> assumptions about physical clock skew or message delays in way way that both respects causality, and relies only on local information.</p>
<h3 id="happens-before">Happens before</h3>
<p>We say that event <code>a</code> <strong>happens before</strong> event <code>b</code> if:</p>
<ol>
<li><code>a</code> happens earlier than <code>b</code> in the same process</li>
<li><code>a</code> is the sending of a message and <code>b</code> is the receipt of that message</li>
<li><code>a</code> happens before <code>c</code> and <code>c</code> happens before <code>b</code>, aka transitivity</li>
</ol>
<p>This is a <strong>partial order</strong>.</p>
<h3 id="happens-concurrently">Happens concurrently</h3>
<p>Two events <code>a</code> and <code>b</code> are said to happen concurrently if neither <code>a</code> happens before <code>b</code> nor <code>b</code> happens before <code>a</code>.</p>
<h3 id="logical-clock-implementation">Logical Clock Implementation</h3>
<ul>
<li>Keep a local clock $T$, and increment it whenever an event happens.</li>
<li>On all messages sent, include a timestamp $T_m$.</li>
<li>On receipt of a message, set $T = \max(T, T_m) + 1$.</li>
</ul>
<h3 id="vector-clocks">Vector Clocks</h3>
<p>Note that with the above implementation of a logic clock system, it was not the case that $T(a) &lt; T(b) \to $ $a$ happened before $b$. With vector clocks, we have $T(a) &lt; T(b) \leftrightarrow a$ happened before $b$ by precisely representing transitive causal relationships between events. This is used in practice for eventual and causal consistency (ie Git, Amazon Dynamo, etc.).</p>
<h4 id="algorithm">Algorithm</h4>
<p>Clock is a vector <code>C</code>, with length = # of nodes in the system</p>
<ul>
<li>On node <code>i</code>, increment <code>C[i]</code> on each event</li>
<li>On receipt of message with clock <code>C_m</code> on node <code>i</code>:</li>
<li>increment <code>C[i]</code></li>
<li>for each <code>j != i</code>, <code>C[j] = max(C[j], C_m[j])</code></li>
</ul>
<pre><code class="language-java">public class VectorClock {
  public final int[] clock;

  public VectorClock(int n) {
    clock = new int[n];
  }

  public void increment(int i) {
    clock[i]++;
  }

  public void handleMessage(VectorClock other) {
    for (int i = 0; i &lt; clock.length; i++)
      clock[i] = Math.max(clock[i], other.clock[i]);
  }
}
</code></pre>
<pre><code class="language-java">public class Node {
  private int id;
  private VectorClock vc;

  public Node(int id, int n) {
    this.id = id;
    this.vc = new VectorClock(n);
  }

  public void event() {
    vc.increment(id);
  }

  public void merge(Node other) {
    vc.handleMessage(other.vc);
  }

  public void send(Node other) {
    other.vc.handleMessage(vc.clock);
  }

  public boolean[] didHappenBefore(Node other) {
    boolean[] res = new boolean[2];
    res[0] = true;
    res[1] = true;

    for (int i = 0; i &lt; vc.clock.length; i++) {
      if (vc.clock[i] &gt; other.vc.clock[i])
        res[0] = false;
       else if (vc.clock[i] &lt; other.vc.clock[i])
        res[1] = false;
    }

    return res;
  }
}
</code></pre>
            </div>
            <div class="tags">
                Tags:
                <a href="/tags/causality.html">causality</a>
                <a href="/tags/clocks.html">clocks</a>
                <a href="/tags/consistency.html">consistency</a>
                <a href="/tags/distributed%20systems.html">distributed systems</a>
                <a href="/tags/logical%20clocks.html">logical clocks</a>
                <a href="/tags/vector%20clocks.html">vector clocks</a>
            </div>
        </article>
    </main>
    <footer role="contentinfo">
        <p>2025, authored by Elijah Melton.</p>
    </footer>
</body>
</html>
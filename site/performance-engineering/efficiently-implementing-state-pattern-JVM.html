
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JVM Performance with State Pattern Optimizations | Elijah's Notes</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Covers the implementation of the state pattern and its performance optimizations on the Java Virtual Machine (JVM). Discusses when to use the state pattern and examines JVM-specific optimizations, including the use of atomic references and lazy evaluation. Presents code blocks to test the performance impact of these techniques in a multithreaded environment.">
    <meta name="author" content="Elijah Melton">
    <meta name="robots" content="index, follow">
    <meta name="generator" content="Custom Static Site Generator">
    <link rel="canonical" href="https://notes.elimelt.com/performance-engineering/efficiently-implementing-state-pattern-JVM.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="JVM Performance with State Pattern Optimizations">
    <meta property="og:description" content="Covers the implementation of the state pattern and its performance optimizations on the Java Virtual Machine (JVM). Discusses when to use the state pattern and examines JVM-specific optimizations, including the use of atomic references and lazy evaluation. Presents code blocks to test the performance impact of these techniques in a multithreaded environment.">
    <meta property="og:url" content="https://notes.elimelt.com/performance-engineering/efficiently-implementing-state-pattern-JVM.html">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="JVM Performance with State Pattern Optimizations">
    <meta name="twitter:description" content="Covers the implementation of the state pattern and its performance optimizations on the Java Virtual Machine (JVM). Discusses when to use the state pattern and examines JVM-specific optimizations, including the use of atomic references and lazy evaluation. Presents code blocks to test the performance impact of these techniques in a multithreaded environment.">

    <meta name="keywords" content="jvm,state pattern,performance optimization,multithreading,atomic reference,lazy evaluation">

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json">
    {"@context": "https://schema.org", "@type": "Article", "headline": "JVM Performance with State Pattern Optimizations", "dateModified": "2025-02-11T20:49:57.925264", "description": "Covers the implementation of the state pattern and its performance optimizations on the Java Virtual Machine (JVM). Discusses when to use the state pattern and examines JVM-specific optimizations, including the use of atomic references and lazy evaluation. Presents code blocks to test the performance impact of these techniques in a multithreaded environment.", "articleSection": "Performance Engineering", "keywords": "jvm,state pattern,performance optimization,multithreading,atomic reference,lazy evaluation"}
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js"></script>

    <!-- Configure KaTeX auto-render -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "\[", right: "\]", display: true},
                    {left: "$", right: "$", display: false},
                ],
                preProcess: (math) => {
                    console.log("Pre-processing: " + math);
                    math = math.split("\n").map((line) => {
                        if (line.endsWith("\\")) {
                            return line + "\\";
                        }
                        return line;
                    }).join("\n");
                    return math;
                },
                throwOnError: false
            });
        });
    </script>

<style>

/* Taxonomy Pages Enhancement - Add this to your existing CSS */

/* Taxonomy List Container */
.taxonomy-container {
    margin: var(--spacing-lg) 0;
}

/* Alphabet Jump Navigation */
.alphabet-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: var(--spacing-lg);
    position: sticky;
    top: 60px; /* Adjust based on your nav height */
    background: var(--background-color);
    padding: var(--spacing-sm) 0;
    z-index: 10;
    border-bottom: 1px solid var(--border-color);
}

.alphabet-nav a {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: var(--radius-sm);
    background: var(--border-color);
    text-decoration: none;
    font-weight: 500;
    transition: all var(--transition-speed);
}

.alphabet-nav a:hover, .alphabet-nav a:focus {
    background: var(--accent-color);
    color: white;
}

.alphabet-nav a.empty {
    opacity: 0.4;
    cursor: default;
}

.alphabet-nav a.empty:hover {
    background: var(--border-color);
    color: var(--text-color);
}

/* Alphabet Section */
.alphabet-section {
    margin-bottom: var(--spacing-lg);
    scroll-margin-top: 120px; /* Ensures the section isn't hidden behind sticky elements */
}

.alphabet-section h2 {
    font-size: 1.8rem;
    padding-bottom: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
    border-bottom: 2px solid var(--accent-color);
    color: var(--accent-color);
}

/* Enhanced List Styling */
.taxonomy-list {
    list-style: none;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--spacing-md);
}

.taxonomy-list li {
    display: flex;
    align-items: center;
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    background: var(--accent-light);
    transition: all var(--transition-speed);
}

.taxonomy-list li:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.taxonomy-list a {
    flex: 1;
    display: block;
    text-decoration: none;
    font-weight: 500;
}

.taxonomy-list .count {
    background: var(--accent-color);
    color: white;
    padding: 0.1rem 0.5rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
}

/* Search Box */
.taxonomy-search {
    margin-bottom: var(--spacing-lg);
    width: 100%;
}

.search-container {
    position: relative;
}

.search-container input {
    width: 100%;
    padding: var(--spacing-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--background-color);
    color: var(--text-color);
    font-size: 1rem;
    transition: all var(--transition-speed);
}

.search-container input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px var(--accent-light);
}

.search-icon {
    position: absolute;
    right: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-color);
    opacity: 0.5;
}

/* No Results Message */
.no-results {
    padding: var(--spacing-lg);
    text-align: center;
    background: var(--border-color);
    border-radius: var(--radius-md);
    margin: var(--spacing-lg) 0;
}

/* Tag Cloud for Tags Page */
.tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin: var(--spacing-lg) 0;
}

.tag-cloud a {
    display: inline-block;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    background: var(--border-color);
    color: var(--text-color);
    text-decoration: none;
    transition: all var(--transition-speed);
    margin-bottom: var(--spacing-sm);
}

.tag-cloud a:hover {
    background: var(--accent-color);
    color: white;
    transform: translateY(-2px);
}

/* Tag sizes based on frequency */
.tag-xs { font-size: 0.8rem; }
.tag-sm { font-size: 0.9rem; }
.tag-md { font-size: 1rem; }
.tag-lg { font-size: 1.2rem; }
.tag-xl { font-size: 1.5rem; }

/* Category Summary Cards */
.category-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-md);
    margin: var(--spacing-lg) 0;
}

.category-card {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    transition: all var(--transition-speed);
    background: var(--background-color);
}

.category-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
    border-color: var(--accent-color);
}

.category-card h3 {
    margin-top: 0;
    margin-bottom: var(--spacing-sm);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: var(--spacing-sm);
}

.category-card .page-count {
    color: var(--accent-color);
    font-weight: bold;
}

.category-card .sample-pages {
    margin-top: var(--spacing-sm);
    font-size: 0.9rem;
}

.category-card .sample-pages a {
    display: block;
    margin-bottom: var(--spacing-sm);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.category-card .view-all {
    display: block;
    text-align: right;
    margin-top: var(--spacing-sm);
    font-weight: 500;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .taxonomy-list {
        grid-template-columns: 1fr;
    }

    .alphabet-nav {
        gap: 0.3rem;
    }

    .alphabet-nav a {
        width: 1.8rem;
        height: 1.8rem;
        font-size: 0.9rem;
    }

    .category-cards {
        grid-template-columns: 1fr;
    }
}

/* Dark mode adjustments */
@media (prefers-color-scheme: dark) {
    .taxonomy-list li {
        background: rgba(96, 165, 250, 0.1);
    }

    .category-card {
        background: var(--background-color);
    }
}

/* Animation for items appearing when filtering */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.taxonomy-list li {
    animation: fadeIn 0.3s ease-out;
}

/* Google Fonts Import */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap');

/* Base Typography Settings */
.content {
    /* Layout and spacing */
    margin-top: 2rem;
    max-width: 70ch;
    margin-left: auto;
    margin-right: auto;
    padding: 0 1.5rem;

    /* Base font settings */
    font-family: 'Merriweather', Georgia, serif;
    font-size: clamp(1rem, 0.95rem + 0.25vw, 1.125rem);
    line-height: 1.75;
    font-weight: 400;

    /* Color and contrast */
    color: rgba(0, 0, 0, 0.87);
    background-color: #fff;

    /* Text rendering */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;

    /* Better spacing */
    letter-spacing: 0.01em;
    word-spacing: 0.05em;

    /* Hyphenation for better text flow */
    hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
}

/* Heading Typography */
.content h1, .content h2, .content h3, .content h4, .content h5, .content h6 {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-weight: 700;
    line-height: 1.3;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: rgba(0, 0, 0, 0.9);
}

.content h1 {
    font-size: clamp(1.75rem, 1.3rem + 2.25vw, 2.5rem);
    letter-spacing: -0.02em;
}

.content h2 {
    font-size: clamp(1.5rem, 1.2rem + 1.5vw, 2rem);
    letter-spacing: -0.015em;
}

.content h3 {
    font-size: clamp(1.25rem, 1.1rem + 0.75vw, 1.5rem);
    letter-spacing: -0.01em;
}

/* Paragraph spacing */
.content p {
    margin-bottom: 1.5rem;
}

.content p + p {
    text-indent: 0.5rem; /* Optional: slight indent for paragraphs after other paragraphs */
}

/* Links with advanced styling */
.content a {
    color: #0366d6;
    text-decoration: none;
    background-image: linear-gradient(transparent calc(100% - 2px), currentColor 2px);
    background-size: 0% 100%;
    background-repeat: no-repeat;
    transition: background-size 0.3s ease-in-out;
}

.content a:hover {
    background-size: 100% 100%;
}

/* Lists with improved spacing */
.content ul, .content ol {
    padding-left: 1.75rem;
    margin-bottom: 1.5rem;
}

.content li {
    margin-bottom: 0.5rem;
}

/* Blockquotes with elegant styling */
.content blockquote {
    margin: 2rem 0;
    padding: 1rem 1.5rem;
    border-left: 4px solid rgba(0, 0, 0, 0.1);
    background-color: rgba(0, 0, 0, 0.02);
    font-style: italic;
    color: rgba(0, 0, 0, 0.75);
}

.content blockquote p:last-child {
    margin-bottom: 0;
}

/* Code blocks */
.content pre, .content code {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.9em;
    background-color: rgba(0, 0, 0, 0.04);
    border-radius: 3px;
}

.content code {
    padding: 0.2em 0.4em;
}

.content pre {
    padding: 1rem;
    overflow-x: auto;
    margin: 1.5rem 0;
}

/* Images */
.content img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    display: block;
    margin: 2rem auto;
}

/* Tables */
.content table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.95em;
}

.content th, .content td {
    padding: 0.75rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.content th {
    background-color: rgba(0, 0, 0, 0.03);
    font-weight: 600;
    text-align: left;
}

/* Figure and captions */
.content figure {
    margin: 2rem 0;
}

.content figcaption {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: rgba(0, 0, 0, 0.6);
    text-align: center;
    font-family: 'Inter', sans-serif;
}

/* Advanced features for better reading */
@media (min-width: 768px) {
    .content {
        /* Better paragraph rhythm using CSS Grid */
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        row-gap: 0rem;

        /* Drop cap for first paragraph */
    }

    .markdown-content p:first-of-type::first-letter {
        float: left;
        font-size: 3.5em;
        line-height: 0.8;
        padding-right: 0.1em;
        font-weight: 700;
    }

    /* Improve reading with advanced CSS columns for certain elements */
    .content .two-column {
        column-count: 2;
        column-gap: 2.5rem;
        column-rule: 1px solid rgba(0, 0, 0, 0.1);
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .content {
        color: rgba(255, 255, 255, 0.87);
        background-color: #1a1a1a;
    }

    .content h1, .content h2, .content h3, .content h4, .content h5, .content h6 {
        color: rgba(255, 255, 255, 0.95);
    }

    .content a {
        color: #58a6ff;
    }

    .content blockquote {
        border-left-color: rgba(255, 255, 255, 0.2);
        background-color: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.7);
    }

    .content pre, .content code {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .content th, .content td {
        border-color: rgba(255, 255, 255, 0.1);
    }

    .content th {
        background-color: rgba(255, 255, 255, 0.05);
    }
}

/* High contrast mode for accessibility */
@media (forced-colors: active) {
    .content a {
        background-image: none;
        text-decoration: underline;
    }
}

/* Print styles for better printing experience */
@media print {
    .content {
        font-size: 12pt;
        line-height: 1.5;
        color: #000;
    }

    .content a {
        text-decoration: underline;
        color: #000;
        background-image: none;
    }

    .content h1, .content h2, .content h3, .content h4, .content h5, .content h6 {
        page-break-after: avoid;
    }

    .content p, .content blockquote, .content ul, .content ol {
        orphans: 3;
        widows: 3;
    }
}

/* Advanced font features */
.content {
    font-feature-settings: 'kern' 1, 'liga' 1, 'calt' 1, 'pnum' 1, 'tnum' 0, 'onum' 1, 'lnum' 0, 'dlig' 0;
}

.content h1, .content h2, .content h3, .content h4, .content h5, .content h6 {
    font-feature-settings: 'kern' 1, 'liga' 1, 'calt' 1, 'pnum' 1, 'tnum' 0, 'onum' 0, 'lnum' 1, 'dlig' 1;
}

/* Selection styling */
.content ::selection {
    background-color: rgba(0, 102, 204, 0.2);
    text-shadow: none;
}

:root {
    --text-color: #1a1a1a;
    --background-color: #ffffff;
    --accent-color: #2563eb;
    --accent-light: rgba(37, 99, 235, 0.1);
    --border-color: #e5e7eb;
    --nav-background: rgba(255, 255, 255, 0.95);
    --code-background: #f3f4f6;
    --transition-speed: 0.2s;
    --content-width: 50rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 2rem;
    --spacing-xl: 3rem;
    --radius-sm: 4px;
    --radius-md: 8px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
}

@media (prefers-color-scheme: dark) {
    :root {
        --text-color: #f3f4f6;
        --background-color: #1a1a1a;
        --accent-color: #60a5fa;
        --accent-light: rgba(96, 165, 250, 0.1);
        --border-color: #374151;
        --nav-background: rgba(26, 26, 26, 0.95);
        --code-background: #2d3748;
    }
}

/* Reset and base styles */
*, *::before, *::after {
    box-sizing: border-box;
}

html {
    font-size: 100%;
    scroll-behavior: smooth;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
    max-width: var(--content-width);
    margin: 0 auto;
    padding: var(--spacing-md);
    color: var(--text-color);
    background: var(--background-color);
    transition: background-color var(--transition-speed), color var(--transition-speed);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

@media (min-width: 768px) {
    body {
        padding: var(--spacing-lg);
    }
}

/* Improved navigation */
nav {
    position: sticky;
    top: 0;
    background: var(--nav-background);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    padding: var(--spacing-md) 0;
    margin: calc(-1 * var(--spacing-md));
    margin-bottom: var(--spacing-lg);
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    z-index: 1000;
    width: calc(100% + var(--spacing-md) * 2);
    padding-left: var(--spacing-md);
    padding-right: var(--spacing-md);
    box-shadow: var(--shadow-sm);
}

@media (min-width: 768px) {
    nav {
        margin: calc(-1 * var(--spacing-lg));
        width: calc(100% + var(--spacing-lg) * 2);
        padding-left: var(--spacing-lg);
        padding-right: var(--spacing-lg);
        gap: var(--spacing-md);
    }
}

nav a {
    color: var(--accent-color);
    text-decoration: none;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    transition: background-color var(--transition-speed), color var(--transition-speed);
    font-weight: 500;
}

nav a:hover, nav a:focus {
    background-color: var(--accent-light);
    outline: none;
}

nav a:focus-visible {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
}

/* Improved breadcrumbs */
.breadcrumbs {
    margin-bottom: var(--spacing-lg);
    color: var(--text-color);
    opacity: 0.8;
    font-size: 0.9rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.breadcrumbs a {
    color: var(--accent-color);
    text-decoration: none;
    transition: color var(--transition-speed);
}

.breadcrumbs a:hover {
    text-decoration: underline;
}

.breadcrumbs span:not(:last-child)::after {
    content: "/";
    margin-left: 0.5rem;
    opacity: 0.5;
}

/* Article styles */
article {
    margin-bottom: var(--spacing-xl);
}

h1, h2, h3, h4, h5, h6 {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    line-height: 1.3;
    font-weight: 600;
}

h1 {
    font-size: 2rem;
    margin-top: 0;
}

h2 {
    font-size: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

/* Meta information styling */
.meta {
    color: var(--text-color);
    opacity: 0.8;
    font-size: 0.9rem;
    margin-bottom: var(--spacing-lg);
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
}

/* Improved code blocks */
code {
    background: var(--code-background);
    padding: 0.2rem 0.4rem;
    border-radius: var(--radius-sm);
    font-size: 0.9em;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
}

pre {
    background: var(--code-background);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin: var(--spacing-lg) 0;
    box-shadow: var(--shadow-sm);
}

pre code {
    background: none;
    padding: 0;
    border-radius: 0;
}

/* Improved links */
a {
    color: var(--accent-color);
    text-decoration: none;
    transition: color var(--transition-speed);
}

a:hover {
    text-decoration: underline;
}

/* Improved image handling */
img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    margin: var(--spacing-lg) 0;
    display: block;
    box-shadow: var(--shadow-md);
}

/* Table improvements */
table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--spacing-lg) 0;
    overflow-x: auto;
    display: block;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-sm);
}

@media (min-width: 768px) {
    table {
        display: table;
    }
}

th, td {
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    text-align: left;
}

th {
    background: var(--border-color);
    font-weight: 600;
}

/* Tags styling */
.tags {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
}

.tags a {
    display: inline-block;
    background: var(--border-color);
    color: var(--text-color);
    padding: 0.2rem 0.6rem;
    border-radius: var(--radius-sm);
    text-decoration: none;
    font-size: 0.9em;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    transition: background-color var(--transition-speed), color var(--transition-speed);
}

.tags a:hover {
    background: var(--accent-color);
    color: white;
    text-decoration: none;
}

/* Footer improvements */
footer {
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-color);
    text-align: center;
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Blockquote styling */
blockquote {
    margin: var(--spacing-lg) 0;
    padding-left: var(--spacing-md);
    border-left: 4px solid var(--accent-color);
    color: var(--text-color);
    opacity: 0.9;
    font-style: italic;
}

/* Improved KaTeX rendering */
.katex-display {
    overflow: auto hidden;
    padding: var(--spacing-md) 0;
    margin: var(--spacing-md) 0;
    background: var(--accent-light);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
}

.katex-display > .katex {
    white-space: normal;
}

.katex {
    font-size: 1.1em;
    line-height: 1.2;
}

.katex-display .katex {
    display: block;
    text-align: center;
}

.katex-display > .katex > .katex-html {
    display: block;
    max-width: 100%;
    overflow-x: auto;
    padding: 0.5em 0;
    min-height: 40px;
}

/* Index page styling */
.landing-stats {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    justify-content: space-around;
}

.stat-item {
    text-align: center;
    padding: var(--spacing-md);
    flex: 1;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent-color);
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Base styles for all screen sizes */
.landing-grid {
    margin: 0 auto;
    padding: 1rem;
    max-width: 1200px;
}

/* Stats section styling */
.stats-section {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.stat-item {
    padding: .5rem;
    text-align: center;
    width: 30%;
}

.stat-number {
    color: #4a88cf;
    font-size: 1.5rem;
    font-weight: bold;
}

.stat-label {
    color: #888;
    font-size: 0.9rem;
}


h2 {
    border-bottom: 1px solid #333;
    padding-bottom: 0.5rem;
    margin-top: 0;
}

/* Recent posts list */
.recent-posts, .categories-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.recent-posts li {
    border-bottom: 1px solid #333;
    padding: 0.75rem 0;
}

.recent-posts li:last-child {
    border-bottom: none;
}

.date, .category {
    color: #888;
    font-size: 0.8rem;
    margin-right: 0.5rem;
}

.category {
    background-color: #3a5e8c;
    border-radius: 3px;
    color: #fff;
    padding: 2px 6px;
}

/* Tags cloud */
.tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tags-cloud a {
    background-color: #3a5e8c;
    border-radius: 3px;
    color: #fff;
    display: inline-block;
    font-size: 0.85rem;
    padding: 0.3rem 0.5rem;
}

/* MOBILE LAYOUT (default) */
.content-area, .sidebar-area {
    width: 100%;
}

/* DESKTOP LAYOUT */
@media (min-width: 768px) {
    .landing-grid {
        display: flex;
        flex-wrap: wrap;
    }

    .stats-section {
        width: 100%;
    }

    .content-area {
        flex: 2;
        margin-right: 1.5rem;
    }

    .sidebar-area {
        flex: 1;
    }

    .recent-section {
        height: 100%;
    }
}

.recent-posts, .categories-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.recent-posts li, .categories-list li {
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--border-color);
}

.recent-posts li:last-child, .categories-list li:last-child {
    border-bottom: none;
}

.recent-posts .date, .recent-posts .category, .categories-list .count {
    font-size: 0.85rem;
    opacity: 0.7;
    margin-left: var(--spacing-sm);
}

.tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
}

.tags-cloud a {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--border-color);
    border-radius: var(--radius-sm);
    text-decoration: none;
    transition: background-color var(--transition-speed), color var(--transition-speed);
}

.tags-cloud a:hover {
    background: var(--accent-color);
    color: white;
    text-decoration: none;
}

.tag-size-1 { font-size: 0.8rem; }
.tag-size-2 { font-size: 0.9rem; }
.tag-size-3 { font-size: 1rem; }
.tag-size-4 { font-size: 1.1rem; }
.tag-size-5 { font-size: 1.2rem; }

/* Focus styles for accessibility */
*:focus-visible {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
}

/* Print styles */
@media print {
    nav, .breadcrumbs, .tags, footer {
        display: none;
    }

    body {
        max-width: none;
        padding: 0;
        color: black;
        background: white;
    }

    a {
        color: black;
        text-decoration: underline;
    }

    .content {
        max-width: 100%;
    }
}

/* Directories styling */
.top-level-links {
    border-left: 4px solid #4a88cf; /* Blue accent border */
    padding-left: 1rem;
}

.top-level-links-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.75rem;
}

.top-level-links-list li {
    margin-bottom: 0.5rem;
}

.top-level-links-list a {
    display: block;
    padding: 0.5rem;
}

</style></head>
<body>
    <header>
        <nav role="navigation" aria-label="Main navigation">
            <a href="/index.html">Home</a>
<a href="/categories/index.html">Categories</a>
<a href="/tags/index.html">Tags</a>
        </nav>
        <div class="breadcrumbs" role="navigation" aria-label="Breadcrumb">
            <a href="/index.html">Home</a> » <a href="/categories/performance%20engineering.html">Performance Engineering</a> » JVM Performance with State Pattern Optimizations
        </div>
    </header>
    <main role="main">
        <article>
            <h1>JVM Performance with State Pattern Optimizations</h1>
            <div class="meta">
                <time datetime="2025-02-11T20:49:57.925264">
                    Last modified: 2025-02-11
                </time>
                <span>Category: <a href="/categories/performance%20engineering.html">Performance Engineering</a></span>
            </div>
            <div class=markdown-content content>
                <h1 id="jvm-performance-with-state-pattern-optimizations">JVM Performance with State Pattern Optimizations</h1>
<p>I was reading some interesting code at AWS and came across an implementation of the state pattern written by one of the senior engineers on our team. If you aren't already familiar, read <a href="https://refactoring.guru/design-patterns/state">this</a>. While the problem I would usually reach to the state pattern to solve is one more concerned with logical complexity and structure, (without revealing anything in particular about the code I was reading) I was intrigued by the performance implications of the underlying implementations, especially in a multi-threaded environment.</p>
<h2 id="the-implementations">The Implementations</h2>
<ol>
<li><strong>Optimized State Pattern Using Enums</strong>: In <code>InlineStatePattern</code>, states are represented as enums with direct in-line transitions. State changes are handled by a simple check and assignment operation.</li>
<li><strong>Generic State Pattern with Lazy Transitions</strong>: In <code>PolymorphicStatePattern</code>, state changes are managed with a generic context using an <code>AtomicReference</code> for thread-safe transitions. Lazy evaluation allows the state to change only if necessary, reducing the overhead in <em>certain cases</em> (emphasis on <em>certain</em>).</li>
</ol>
<h2 id="when-might-i-reach-for-either">When might I reach for either?</h2>
<ol>
<li><strong>Inline State Pattern</strong>:</li>
<li>Use when state transitions are simple and predictable.</li>
<li>
<p>Ideal for low contention scenarios where synchronization overhead is a concern. For example, in a high-throughput system with little locking overhead, like a cache or a message queue.</p>
</li>
<li>
<p><strong>Generic State Pattern</strong>:</p>
</li>
<li>Use when state transitions are complex or require additional logic.</li>
<li>Ideal for high contention scenarios where synchronization is necessary. For example, in a shared resource or a asynchronous/distributed system. Note that while I'm saying high contention, this is not a hard and fast rule. It's more about the nature of the contention and the nature of the state transitions, e.g. if the state transitions are complex and the contention is low, you might still want to use the generic state patter for the sake of readability maintainability.</li>
</ol>
<h3 id="jvm-optimizations-and-overheads">JVM Optimizations and Overheads</h3>
<ol>
<li><strong>Enum-Based State Handling (Inlined Transitions)</strong>:</li>
<li>Enums offer low-level performance wins by making state transitions in-line without additional method calls or object creation. OpenJDK initial</li>
<li>
<p>In this setup, each <code>DocumentState</code> enum implements its own <code>handle</code> and <code>nextState</code> methods. Transitioning states here is a simple assignment with little locking overhead, so the JVM can optimize by inlining these transitions at runtime.</p>
</li>
<li>
<p><strong>Generic Interface with <code>AtomicReference</code></strong>:</p>
</li>
<li><code>AtomicReference</code> ensures thread safety for transitions, but adds some overhead due to its CAS (Compare-and-Swap) operations, which are costly under high contention.</li>
<li>With lazy state transition, this implementation could theoretically avoid unnecessary state updates, which may be beneficial under lower contention.</li>
</ol>
<h2 id="predictions-and-testing">Predictions and Testing</h2>
<p>Based on JVM behaviors, here are our predictions:</p>
<ol>
<li><strong>Single-threaded Performance</strong>:</li>
<li>
<p><code>InlineStatePattern</code> should outperform <code>PolymorphicStatePattern</code> in single-threaded scenarios due to reduced overhead from <code>AtomicReference</code>.</p>
</li>
<li>
<p><strong>Multi-threaded Performance</strong>:</p>
</li>
<li>At lower levels of contention, <code>InlineStatePattern</code> should still perform better due to fewer synchronization requirements.</li>
<li>Under high contention, the <code>AtomicReference</code> CAS operations in <code>PolymorphicStatePattern</code> may actually limit performance due to frequent retries.</li>
</ol>
<p>To verify these assumptions, let’s test using the following code blocks. You can add these into the <code>main</code> method to see the results.</p>
<h3 id="code-blocks-to-test-performance">Code Blocks to Test Performance</h3>
<ol>
<li><strong>Single-Threaded Performance Test</strong>:</li>
</ol>
<pre><code class="language-java">   Document doc1 = new InlineStatePattern.Document(&quot;Single-threaded Test&quot;);
   benchmark(&quot;Optimized State Pattern - Single Thread&quot;, 10_000_000, doc1::handleState);

   Document doc2 = new PolymorphicStatePattern.Document(&quot;Single-threaded Test&quot;);
   benchmark(&quot;Generic State Pattern - Single Thread&quot;, 10_000_000, doc2::handleState);
</code></pre>
<p>Here, I predict <code>InlineStatePattern</code> will complete faster, as it avoids the overhead of <code>AtomicReference</code> and CAS operations.</p>
<pre><code class="language-txt">Inline State Pattern - Single Thread: 201363 µs for 10000000 iterations (0.02 µs/op) - Last result: Published: Single-threaded Test
Polymorphic State Pattern - Single Thread: 133314 µs for 10000000 iterations (0.01 µs/op) - Last result: Published: Single-threaded Test
</code></pre>
<p>As expected, <code>InlineStatePattern</code> outperforms <code>PolymorphicStatePattern</code> in a single-threaded scenario by roughly 50%.</p>
<ol>
<li><strong>Multi-Threaded Performance Test with Low Contention:</strong>:</li>
</ol>
<pre><code class="language-java">Document sharedDoc1 = new InlineStatePattern.Document(&quot;Multi-thread Test&quot;);
Thread[] threads1 = new Thread[4];
for (int i = 0; i &lt; threads1.length; i++) {
    threads1[i] = new Thread(() -&gt; {
        benchmark(&quot;Optimized Pattern - Multi-thread Low Contention&quot;, 2_500_000, sharedDoc1::handleState);
    });
    threads1[i].start();
}

Document sharedDoc2 = new PolymorphicStatePattern.Document(&quot;Multi-thread Test&quot;);
Thread[] threads2 = new Thread[4];
for (int i = 0; i &lt; threads2.length; i++) {
    threads2[i] = new Thread(() -&gt; {
        benchmark(&quot;Generic Pattern - Multi-thread Low Contention&quot;, 2_500_000, sharedDoc2::handleState);
    });
    threads2[i].start();
}
</code></pre>
<p>Here, <code>InlineStatePattern</code> should still outperform <code>PolymorphicStatePattern</code>, as the contention is low.</p>
<pre><code class="language-txt">Polymorphic Pattern - Multi-thread Low Contention: 339159 µs for 2500000 iterations (0.14 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 360859 µs for 2500000 iterations (0.14 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 348844 µs for 2500000 iterations (0.14 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 375313 µs for 2500000 iterations (0.15 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 342431 µs for 2500000 iterations (0.14 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 368308 µs for 2500000 iterations (0.15 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 368001 µs for 2500000 iterations (0.15 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 385776 µs for 2500000 iterations (0.15 µs/op) - Last result: Published: Multi-thread Test
idata = [339159, 360859, 348844, 375313]
pdata = [342431, 368308, 368001, 385776]
</code></pre>
<p>As you can see however, despite being roughly neck and neck with Poly and Inline having respective averages of <code>356043.75</code> (<code>0.1424175 µs/op</code>) and <code>366129.0</code> (<code>0.1464516 µs/op</code>), the Inline pattern is actually slightly slower in this case. Since I hate being proven wrong, I also wonder if the results would be different if we swapped the order of the tests.</p>
<pre><code class="language-txt">Polymorphic Pattern - Multi-thread Low Contention: 494816 µs for 2500000 iterations (0.20 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 481862 µs for 2500000 iterations (0.19 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 491883 µs for 2500000 iterations (0.20 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 492075 µs for 2500000 iterations (0.20 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 455870 µs for 2500000 iterations (0.18 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 491346 µs for 2500000 iterations (0.20 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 483745 µs for 2500000 iterations (0.19 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 475941 µs for 2500000 iterations (0.19 µs/op) - Last result: Published: Multi-thread Test
idata = [494816, 481862, 491883, 492075]
pdata = [455870, 491346, 483745, 475941]
</code></pre>
<p>This time, we have a Poly and Inline average of <code>490159.0</code> (<code>0.1960636 µs/op</code>) and <code>476225.5</code> (<code>0.1904902 µs/op</code>) respectively. Well well well...</p>
<p>Lets try this one more time, running the tests twice, while also isolating them to their own JVM instances.</p>
<pre><code class="language-txt">Polymorphic Pattern - Multi-thread Low Contention: 372321 µs for 2500000 iterations (0.15 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 387558 µs for 2500000 iterations (0.16 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 402434 µs for 2500000 iterations (0.16 µs/op) - Last result: Published: Multi-thread Test
Polymorphic Pattern - Multi-thread Low Contention: 407174 µs for 2500000 iterations (0.16 µs/op) - Last result: Published: Multi-thread Test
pdata = [372321, 387558, 402434, 407174]
</code></pre>
<pre><code class="language-txt">Inline Pattern - Multi-thread Low Contention: 397600 µs for 2500000 iterations (0.16 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 398064 µs for 2500000 iterations (0.16 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 392855 µs for 2500000 iterations (0.16 µs/op) - Last result: Published: Multi-thread Test
Inline Pattern - Multi-thread Low Contention: 419996 µs for 2500000 iterations (0.17 µs/op) - Last result: Published: Multi-thread Test
idata = [397600, 398064, 392855, 419996]
</code></pre>
<p>So we have a Inline average of <code>402128.75</code> (<code>0.1608515 µs/op</code>) and a Poly average of <code>392371.75</code> (<code>0.1569487 µs/op</code>). So it seems that the Inline pattern is actually slower in this case. <code>AtomicReference</code>s are preetttty pretty good.</p>
<ol>
<li><strong>High Contention Test with Increased Threads:</strong></li>
</ol>
<pre><code class="language-java">Document highContDoc1 = new InlineStatePattern.Document(&quot;High Contention Test&quot;);
Document highContDoc2 = new PolymorphicStatePattern.Document(&quot;High Contention Test&quot;);

for (int i = 0; i &lt; 8; i++) {
    new Thread(() -&gt; {
        benchmark(&quot;Optimized Pattern - High Contention&quot;, 1_250_000, highContDoc1::handleState);
    }).start();
}

for (int i = 0; i &lt; 8; i++) {
    new Thread(() -&gt; {
        benchmark(&quot;Generic Pattern - High Contention&quot;, 1_250_000, highContDoc2::handleState);
    }).start();
}
</code></pre>
<p>With more threads, we expect contention to impact <code>PolymorphicStatePattern</code> more due to frequent CAS retries in AtomicReference.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The low-level optimizations in <code>InlineStatePattern</code> using enums make it ideal for performance-critical, low-contention use cases. <code>PolymorphicStatePattern</code>, with its AtomicReference, offers better safety for concurrent environments but incurs a trade-off in performance due to CAS operations. Testing under these scenarios confirms that the right implementation depends on your application’s specific threading needs.</p>
            </div>
            <div class="tags">
                Tags:
                <a href="/tags/atomic%20reference.html">atomic reference</a>
                <a href="/tags/jvm.html">jvm</a>
                <a href="/tags/lazy%20evaluation.html">lazy evaluation</a>
                <a href="/tags/multithreading.html">multithreading</a>
                <a href="/tags/performance%20optimization.html">performance optimization</a>
                <a href="/tags/state%20pattern.html">state pattern</a>
            </div>
        </article>
    </main>
    <footer role="contentinfo">
        <p>2025, authored by Elijah Melton.</p>
    </footer>
</body>
</html>